# システムアーキテクチャ設計

## 概要

GMレスLoL風TRPGをWebアプリケーションとして実装するための、システムアーキテクチャ設計書。

---

## アーキテクチャパターン

### 採用パターン: **クライアント・サーバー型 + リアルタイム通信**

```
┌──────────────────────────────────────────────────────────────┐
│                        クライアント層                          │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Webブラウザ (React/Vue/Svelte)                         │  │
│  │  - UI表示                                              │  │
│  │  - ユーザー入力受付                                     │  │
│  │  - リアルタイム更新表示                                 │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
                          ↕ WebSocket / REST API
┌──────────────────────────────────────────────────────────────┐
│                        サーバー層                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ APIサーバー (Node.js/TypeScript)                       │  │
│  │  - WebSocketサーバー                                   │  │
│  │  - REST APIエンドポイント                              │  │
│  │  - セッション管理                                       │  │
│  └────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ ゲームロジック層                                        │  │
│  │  - ゲームエンジン                                       │  │
│  │  - ルール処理                                           │  │
│  │  - 判定・計算ロジック                                   │  │
│  │  - CPU AI (オプション)                                 │  │
│  └────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ データアクセス層                                        │  │
│  │  - ORM/データマッパー                                  │  │
│  │  - リポジトリパターン                                   │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
                          ↕ SQL/NoSQL
┌──────────────────────────────────────────────────────────────┐
│                        データ層                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ PostgreSQL/MongoDB                                     │  │
│  │  - ゲームセッションデータ                               │  │
│  │  - プレイヤーデータ                                     │  │
│  │  - ランキング・統計                                     │  │
│  └────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Redis (オプション)                                      │  │
│  │  - セッションキャッシュ                                 │  │
│  │  - リアルタイムゲーム状態                               │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

---

## レイヤー設計

### 1. クライアント層 (Frontend)

#### 責務
- ゲーム画面のレンダリング
- ユーザー入力（行動選択、移動、アイテム購入など）
- リアルタイムゲーム状態の表示
- アニメーション・エフェクト

#### 主要コンポーネント
```
src/client/
├── components/          # UIコンポーネント
│   ├── GameBoard/      # ゲーム盤面
│   ├── CharacterCard/  # キャラクター情報
│   ├── ActionPanel/    # 行動選択パネル
│   ├── Shop/           # アイテムショップ
│   └── GameLog/        # ゲームログ
├── stores/             # 状態管理 (Vuex/Redux/Pinia)
│   ├── gameState.ts
│   ├── playerState.ts
│   └── uiState.ts
├── services/           # API通信
│   ├── api.ts
│   └── websocket.ts
└── utils/              # ユーティリティ
    ├── animations.ts
    └── formatters.ts
```

#### 通信方式
- **WebSocket**: リアルタイムゲーム状態更新、プレイヤー行動通知
- **REST API**: ゲーム作成、ユーザー登録、履歴取得

---

### 2. サーバー層 (Backend)

#### 2-1. APIサーバー

**責務**: クライアントとの通信、セッション管理

```
src/server/
├── api/                # REST APIエンドポイント
│   ├── game.ts         # ゲーム作成・参加
│   ├── player.ts       # プレイヤー管理
│   └── history.ts      # 履歴・統計
├── websocket/          # WebSocketハンドラー
│   ├── connection.ts   # 接続管理
│   ├── actions.ts      # 行動送信
│   └── events.ts       # イベント配信
└── middleware/         # ミドルウェア
    ├── auth.ts         # 認証
    ├── validation.ts   # バリデーション
    └── errorHandler.ts # エラーハンドリング
```

#### 2-2. ゲームロジック層

**責務**: ゲームルールの実装、判定処理

```
src/game/
├── engine/             # ゲームエンジン
│   ├── GameEngine.ts   # メインエンジン
│   ├── RoundManager.ts # ラウンド管理
│   └── StateManager.ts # 状態管理
├── rules/              # ルール処理
│   ├── combat.ts       # 戦闘判定
│   ├── movement.ts     # 移動処理
│   ├── skills.ts       # スキル処理
│   └── items.ts        # アイテム効果
├── systems/            # システム
│   ├── matchup.ts      # マッチアップ判定
│   ├── damage.ts       # ダメージ計算
│   ├── tower.ts        # タワーシステム
│   ├── minion.ts       # ミニオンシステム
│   └── objectives.ts   # オブジェクトシステム
├── ai/                 # CPU AI (オプション)
│   ├── AIController.ts # AI制御
│   ├── strategies/     # 戦略パターン
│   └── difficulty.ts   # 難易度調整
└── config/             # 設定読み込み
    └── ConfigLoader.ts # YAML設定読み込み
```

#### 2-3. データアクセス層

**責務**: データベース操作の抽象化

```
src/database/
├── models/             # データモデル
│   ├── Game.ts
│   ├── Player.ts
│   ├── Character.ts
│   └── GameHistory.ts
├── repositories/       # リポジトリ
│   ├── GameRepository.ts
│   ├── PlayerRepository.ts
│   └── HistoryRepository.ts
└── migrations/         # マイグレーション
    └── *.sql
```

---

### 3. データ層

#### 3-1. PostgreSQL/MongoDB

**保存データ**:
- ゲームセッション（現在進行中のゲーム）
- プレイヤープロフィール
- ゲーム履歴（リプレイ用）
- ランキング・統計データ

#### 3-2. Redis (オプション)

**保存データ**:
- アクティブゲームのリアルタイム状態
- WebSocketセッション管理
- 一時キャッシュ

---

## 主要な設計パターン

### 1. **Repository パターン**
データアクセスロジックを抽象化し、ビジネスロジックから分離。

```typescript
interface GameRepository {
  create(game: Game): Promise<Game>;
  findById(id: string): Promise<Game | null>;
  update(game: Game): Promise<Game>;
  delete(id: string): Promise<void>;
}
```

### 2. **Strategy パターン**
CPU AIの難易度別戦略を実装。

```typescript
interface AIStrategy {
  selectAction(gameState: GameState, character: Character): Action;
}

class EasyAI implements AIStrategy { /* ... */ }
class MediumAI implements AIStrategy { /* ... */ }
class HardAI implements AIStrategy { /* ... */ }
```

### 3. **Observer パターン**
ゲーム状態の変更をクライアントに通知。

```typescript
class GameEngine {
  private observers: Observer[] = [];

  notify(event: GameEvent) {
    this.observers.forEach(obs => obs.update(event));
  }
}
```

### 4. **Command パターン**
プレイヤーの行動を統一的に処理。

```typescript
interface Command {
  execute(gameState: GameState): void;
  undo?(gameState: GameState): void;
}

class AttackCommand implements Command { /* ... */ }
class MoveCommand implements Command { /* ... */ }
```

---

## データフロー

### ゲーム開始時

```
1. クライアント → サーバー: ゲーム作成リクエスト (REST)
2. サーバー: ゲームセッション作成
3. サーバー → DB: ゲーム情報保存
4. サーバー → クライアント: ゲームID返却
5. クライアント → サーバー: WebSocket接続 (game_id)
6. サーバー: プレイヤー接続登録
```

### ラウンド進行時

```
[行動宣言フェーズ]
1. クライアント → サーバー: 行動宣言 (WebSocket)
2. サーバー: 全プレイヤーの宣言を待機
3. サーバー → 全クライアント: 行動宣言完了通知

[解決フェーズ]
4. サーバー: ゲームエンジンで行動解決
   - 移動処理
   - 戦闘判定
   - ダメージ計算
   - リソース獲得
   etc.
5. サーバー → DB: ゲーム状態保存
6. サーバー → 全クライアント: ゲーム状態更新 (WebSocket)
7. クライアント: UI更新・アニメーション表示
```

---

## スケーラビリティ考慮

### 水平スケーリング

1. **ステートレスAPIサーバー**
   - セッション情報はRedisに保存
   - 複数のAPIサーバーインスタンスを起動可能

2. **ゲームルーム分散**
   - 各ゲームセッションは独立して処理
   - ロードバランサーでゲームルームを複数サーバーに分散

3. **データベースレプリケーション**
   - マスター・スレーブ構成
   - 読み取り負荷を分散

---

## セキュリティ設計

### 1. **チート防止**
- すべてのゲームロジックをサーバーサイドで実行
- クライアントはUIのみ（ダイスロール、判定はサーバー側）
- 行動宣言の妥当性チェック

### 2. **認証・認可**
- JWT認証（オプション）
- セッション管理
- レート制限（DDoS対策）

### 3. **データバリデーション**
- クライアントからの入力を厳格にバリデーション
- SQLインジェクション対策
- XSS対策

---

## パフォーマンス最適化

### 1. **リアルタイム通信最適化**
- WebSocketのメッセージサイズ削減（差分のみ送信）
- バイナリプロトコル（Protocol Buffers/MessagePack）

### 2. **データベース最適化**
- インデックス設計
- クエリ最適化
- コネクションプーリング

### 3. **キャッシング**
- ゲーム設定データ（game_balance.yaml）のメモリキャッシュ
- 頻繁にアクセスされるデータのRedisキャッシュ

---

## 監視・ログ

### 1. **ログ収集**
- アプリケーションログ（Winston/Pino）
- アクセスログ
- エラーログ

### 2. **メトリクス監視**
- アクティブゲーム数
- 接続プレイヤー数
- API応答時間
- CPU/メモリ使用率

### 3. **アラート**
- エラー率の急増
- サーバーダウン
- データベース接続エラー

---

## デプロイメント

### 開発環境
- Docker Compose
- ローカルPostgreSQL/MongoDB

### 本番環境（候補）
- **クラウドプロバイダー**: AWS/GCP/Azure
- **コンテナ**: Docker + Kubernetes
- **CI/CD**: GitHub Actions / GitLab CI
- **監視**: Prometheus + Grafana / Datadog

---

## 今後の拡張性

### フェーズ1: MVP (最小機能)
- 1vs1対戦モード
- 基本的なゲームルール実装
- シンプルなUI

### フェーズ2: マルチプレイヤー
- 2-10人対戦
- チャット機能
- リプレイ機能

### フェーズ3: 高度な機能
- CPUモード（AI実装）
- ランクマッチ
- カスタムマッチ
- オブザーバーモード

### フェーズ4: ソーシャル機能
- フレンド機能
- ランキング
- トーナメント機能

---

## 変更履歴

- 2025-11-11: 初版作成
